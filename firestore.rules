rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // --- Profile Rules ---
    // Users can read their own profile.
    // They can create it.
    // They can ONLY update their display_name and photo_url. All other fields are locked.
    match /profiles/{userId} {
      allow read, create: if isOwner(userId);
      allow update: if isOwner(userId) 
                    && request.resource.data.keys().hasOnly(['display_name', 'photo_url', 'updated_at'])
                    && request.resource.data.display_name is string
                    && request.resource.data.photo_url is string;

      // Transactions can only be created by the server (Cloud Functions).
      // Users can read their own transaction history.
      match /transactions/{transactionId} {
        allow read: if isOwner(userId);
        allow create, update, delete: if false; 
      }
    }

    // --- Tasks (Marketplace) ---
    // Anyone can read the tasks.
    // Creating, updating, deleting must be done via Cloud Functions.
    match /tasks/{taskId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if false;
    }

    // --- Public Read-Only Collections ---
    // These are seeded by an admin Cloud Function. Client can only read.
    match /credit_packs/{packId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if false;
    }
    match /learning_modules/{moduleId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if false;
    }
    match /mentors/{mentorId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if false;
    }
    match /templates/{templateId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if false;
    }

    // --- Internal Admin-Only ---
    // Used by seed function to prevent re-runs. Not client-accessible.
    match /internal/{docId} {
        allow read, write: if false;
    }
  }
}
