
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Profile Data ---
    // Users can read their own profile.
    // Users can update their display name and photo url.
    // Users CANNOT update their own credits or reputation directly.
    match /profiles/{userId} {
      allow read: if request.auth.uid == userId;
      // Allow users to update only specific, non-sensitive fields.
      allow update: if request.auth.uid == userId && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['display_name', 'photo_url']);
      allow create: if request.auth.uid == userId;
    }

    // Allow users to read their own transaction history
    match /profiles/{userId}/transactions/{transactionId} {
        allow read, create: if request.auth.uid == userId;
    }

    // --- Public Read-Only Data ---
    // Anyone authenticated can read templates, modules, and mentors.
    match /templates/{templateId} {
      allow list, get: if request.auth != null;
    }
    match /learning_modules/{moduleId} {
      allow list, get: if request.auth != null;
    }
    match /mentors/{mentorId} {
        allow list, get: if request.auth != null;
    }
     match /credit_packs/{packId} {
        allow list, get: if request.auth != null;
    }

    // --- Marketplace Tasks ---
    match /tasks/{taskId} {
      // Anyone authenticated can view (list and get) tasks.
      allow list, get: if request.auth != null;

      // Logged-in user can create a task. Credits are handled by a function.
      allow create: if request.auth != null && request.resource.data.created_by == request.auth.uid;
      
      // Allow updates based on task status transitions
      allow update: if request.auth != null && (
        // Case 1: Accepting a task
        (resource.data.status == 'OPEN' && request.resource.data.status == 'ASSIGNED' && request.resource.data.assigned_to == request.auth.uid) ||
        // Case 2: Completing a task
        (resource.data.status == 'ASSIGNED' && request.resource.data.status == 'COMPLETED' && resource.data.assigned_to == request.auth.uid) ||
        // Case 3: Task creator cancelling an OPEN task
        (resource.data.status == 'OPEN' && request.resource.data.status == 'CANCELLED' && resource.data.created_by == request.auth.uid) ||
        // Case 4: Approving a task (status set to PAID by cloud function)
        (resource.data.status == 'COMPLETED' && request.resource.data.status == 'PAID' && resource.data.created_by == request.auth.uid)
      );
    }
  }
}
